# PRP-025: PWA Configuration

## Status
ðŸ”² Not Started

## Priority
P2 - Medium (Mobile enhancement)

## Objective
Configure Progressive Web App (PWA) features including service worker for offline support, app manifest, caching strategies, push notifications, and installable app experience.

## Scope

### Files to Create
- `public/manifest.json` - PWA manifest file
- `public/sw.js` - Service worker (auto-generated by next-pwa)
- `public/icons/icon-192x192.png` - App icon 192x192
- `public/icons/icon-512x512.png` - App icon 512x512
- `public/icons/apple-touch-icon.png` - iOS app icon
- `public/icons/favicon.ico` - Favicon
- `src/lib/pwa/push-notifications.ts` - Push notification utilities
- `src/lib/pwa/install-prompt.ts` - Install prompt handler
- `src/components/pwa/InstallPrompt.tsx` - Install banner component
- `src/components/pwa/OfflineBanner.tsx` - Offline mode indicator
- `src/components/pwa/UpdatePrompt.tsx` - Update available prompt
- `src/hooks/useOnlineStatus.ts` - Online/offline detection hook
- `src/hooks/useInstallPrompt.ts` - Install prompt hook
- `src/app/offline/page.tsx` - Offline fallback page
- `tests/pwa/service-worker.test.ts` - Service worker tests

### Dependencies to Install
```bash
npm install next-pwa
npm install workbox-webpack-plugin workbox-window
```

## Implementation Steps

1. **Configure next-pwa**
   - Install and configure next-pwa plugin
   - Update `next.config.js` with PWA settings
   - Configure workbox caching strategies
   - Set cache expiration policies
   - Exclude admin routes from offline cache

2. **Create App Manifest**
   - Define app name, short name, description
   - Set theme color and background color
   - Specify display mode (standalone)
   - Define app icons (192x192, 512x512)
   - Set start URL and scope
   - Configure shortcuts for quick actions

3. **Implement Service Worker**
   - Register service worker in app
   - Cache static assets (JS, CSS, images)
   - Cache API responses with strategies:
     - **Network First**: For real-time data
     - **Cache First**: For static content
     - **Stale While Revalidate**: For API data
   - Implement background sync
   - Handle offline fallback

4. **Create Offline Support**
   - Detect online/offline status
   - Show offline banner when disconnected
   - Queue mutations during offline
   - Sync when back online
   - Offline fallback page for navigation
   - Cache critical pages for offline access

5. **Implement Push Notifications**
   - Request notification permission
   - Register push subscription
   - Store subscription in database
   - Send push notifications from server
   - Handle notification click events
   - Notification preferences per user

6. **Add Install Prompt**
   - Detect installability
   - Show custom install banner
   - Trigger browser install prompt
   - Track install analytics
   - Dismiss permanently option
   - Show installed state

7. **Create App Icons**
   - Design 512x512 base icon
   - Generate smaller sizes (192x192, 144x144, etc.)
   - Create iOS-specific icons
   - Add favicon variants
   - Test icons on different devices

8. **Implement Update Detection**
   - Detect when new version available
   - Show "Update Available" prompt
   - Reload to activate new version
   - Skip waiting for critical updates
   - Version number display

9. **Add PWA Meta Tags**
   - Apple-specific meta tags
   - Theme color meta tag
   - Viewport meta tag
   - Web app capable meta tags
   - Mask icon for Safari

## Acceptance Criteria

- [ ] App can be installed on desktop and mobile devices
- [ ] Service worker caches static assets correctly
- [ ] App works offline with cached data
- [ ] Offline banner appears when disconnected
- [ ] Push notifications work on supported browsers
- [ ] Install prompt appears on first visit (mobile)
- [ ] App icons display correctly when installed
- [ ] Update prompt appears when new version deployed
- [ ] Lighthouse PWA score >90
- [ ] App passes PWA installability checklist
- [ ] Background sync queues offline actions
- [ ] All tests pass with >80% coverage

## Validation Steps

```bash
# 1. Install next-pwa
npm install next-pwa workbox-webpack-plugin workbox-window

# 2. Update next.config.js with PWA settings
# (Add withPWA wrapper)

# 3. Run build to generate service worker
npm run build

# 4. Start production server
npm run start

# 5. Test service worker registration
# Open DevTools -> Application -> Service Workers
# Verify service worker registered and activated

# 6. Test offline mode
# DevTools -> Network -> Check "Offline"
# Navigate app
# Verify app loads from cache
# Verify offline banner appears

# 7. Test install prompt
# Visit on mobile device
# Verify install banner appears
# Click "Install"
# Verify app added to home screen

# 8. Test push notifications
# Click "Enable Notifications" in app
# Send test notification from server
# Verify notification appears

# 9. Test caching strategies
# Load project list (should use Network First)
# Load same page again
# Verify faster load (cache hit)
# Check DevTools -> Application -> Cache Storage

# 10. Test update detection
# Make code change and rebuild
# Reload app
# Verify "Update Available" prompt appears
# Click "Update"
# Verify new version loads

# 11. Test icons
# Install app on iOS device
# Verify icon displays correctly on home screen
# Install on Android
# Verify icon displays correctly

# 12. Run Lighthouse audit
npm run lighthouse
# Or use Chrome DevTools -> Lighthouse
# Target: PWA score >90

# 13. Verify manifest
# Visit https://localhost:3000/manifest.json
# Verify JSON is valid

# 14. Test on multiple browsers
# Chrome (full PWA support)
# Safari (limited PWA support)
# Firefox (good PWA support)
# Edge (full PWA support)

# 15. Run PWA tests
npm test -- tests/pwa/
```

## Expected Output

```
âœ“ next-pwa configured in Next.js
âœ“ App manifest with icons and metadata
âœ“ Service worker caching static assets
âœ“ Offline support with fallback page
âœ“ Push notifications working
âœ“ Install prompt on mobile devices
âœ“ App icons for all platforms
âœ“ Update detection and prompt
âœ“ Lighthouse PWA score >90
âœ“ All tests passing (>80% coverage)
```

## Manifest Configuration

```json
{
  "name": "PPH Capacity Management Tool",
  "short_name": "PPH Capacity",
  "description": "Manage construction projects, capacity, and financials",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0070f3",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "shortcuts": [
    {
      "name": "Projects",
      "url": "/projects",
      "icons": [{ "src": "/icons/projects.png", "sizes": "96x96" }]
    },
    {
      "name": "Capacity",
      "url": "/capacity",
      "icons": [{ "src": "/icons/capacity.png", "sizes": "96x96" }]
    }
  ]
}
```

## Caching Strategies

```javascript
// next.config.js PWA configuration
const withPWA = require('next-pwa')({
  dest: 'public',
  register: true,
  skipWaiting: true,
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/api\..*$/,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'api-cache',
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 60 * 5 // 5 minutes
        }
      }
    },
    {
      urlPattern: /\.(?:png|jpg|jpeg|svg|gif)$/,
      handler: 'CacheFirst',
      options: {
        cacheName: 'image-cache',
        expiration: {
          maxEntries: 100,
          maxAgeSeconds: 60 * 60 * 24 * 30 // 30 days
        }
      }
    }
  ]
})
```

## Related PRPs
- Depends on: PRP-001 (Project Initialization), PRP-026 (Mobile Optimization)
- Related: PRP-024 (WebSocket Real-time), PRP-018 (Financial Alerts)
- Blocks: None (optional enhancement)

## Estimated Time
8-10 hours

## Notes
- PWA works best on HTTPS (required for service workers)
- iOS Safari has limited PWA support (no push notifications yet)
- Service worker updates require hard refresh or skipWaiting
- Test on actual devices, not just emulators
- Consider background sync for offline actions (Background Sync API)
- Add app shortcuts for common actions (manifest shortcuts)
- Use maskable icons for adaptive icons on Android
- Implement share target for receiving shared content
- Consider app badging API for unread notifications
- Cache selectively (don't cache everything)
- Set reasonable cache expiration times
- Monitor cache size (quotas vary by browser)
- Test offline scenarios thoroughly
- Add analytics for PWA install/usage
- Consider A2HS (Add to Home Screen) detection

## Browser Support
- **Chrome/Edge**: Full PWA support including push notifications
- **Firefox**: Good PWA support, push notifications supported
- **Safari**: Limited PWA support, no push notifications (as of 2024)
- **Samsung Internet**: Full PWA support

## Rollback Plan
If validation fails:
1. Check next-pwa installation: `npm list next-pwa`
2. Verify next.config.js PWA configuration
3. Check service worker registration in DevTools
4. Test with simple caching strategy first
5. Verify HTTPS enabled (required for PWA)
6. Check manifest.json is valid JSON
7. Verify icons exist at specified paths
8. Test in Chrome DevTools Application tab
9. Run Lighthouse to diagnose issues
10. Check browser console for service worker errors
